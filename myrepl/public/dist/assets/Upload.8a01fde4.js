import{bo as H,_ as J,o as W,d as G,u as X,e as C,bL as Z,j as o,r as S,a1 as U,B as L,x as q,I as M,X as _,a8 as x,n as K,bs as O,Z as Q,aS as Y,a7 as j,bJ as E,aP as T,bM as ee,aj as te,bN as ae,bO as oe,bP as ne,p as re}from"./index.fef1c441.js";import{a as se,b as le}from"./index.2ca628c1.js";async function*ie(a,i,d){const n=new Set;async function u(){const[p,s]=await Promise.race(n);return n.delete(p),s}for(const p of i){const s=(async()=>await d(p,i))().then(c=>[s,c]);n.add(s),n.size>=a&&(yield await u())}for(;n.size;)yield await u()}const ce={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},de=async a=>{let i=[];const d=async(n,u)=>{await new Promise((s,c)=>{const l=r=>{console.error(r),c(r)};if(n.isFile)n.file(r=>{const m=new File([r],u+r.name,{type:r.type});i.push(m),console.log(m),s({})},l);else if(n.isDirectory){const r=n.createReader(),m=()=>{r.readEntries(async g=>{for(let f=0;f<g.length;f++)await d(g[f],u+n.name+"/");s({}),g.length>0&&m()},l)};m()}})};return await d(a,""),i},ue=a=>({name:a.name,path:a.webkitRelativePath?a.webkitRelativePath:a.name,size:a.size,progress:0,speed:0,status:"pending"}),pe=async(a,i,d,n=!1)=>{let u=new Date().valueOf(),p=0;const s=new FormData;s.append("file",i);const c=await H.put("/fs/form",s,{headers:{"File-Path":encodeURIComponent(a),"As-Task":n,"Content-Type":"multipart/form-data","Last-Modified":i.lastModified,Password:J()},onUploadProgress:l=>{if(l.total){const r=l.loaded/l.total*100|0;d("progress",r);const m=new Date().valueOf(),g=(m-u)/1e3;if(g>1){const k=(l.loaded-p)/g,F=(l.total-l.loaded)/k;d("speed",k),console.log(F),u=m,p=l.loaded}r===100&&d("status","backending")}}});if(c.code!==200)return new Error(c.message)},me=async(a,i,d,n=!1)=>{let u=new Date().valueOf(),p=0;const s=await H.put("/fs/put",i,{headers:{"File-Path":encodeURIComponent(a),"As-Task":n,"Content-Type":i.type||"application/octet-stream","Last-Modified":i.lastModified,Password:J()},onUploadProgress:c=>{if(c.total){const l=c.loaded/c.total*100|0;d("progress",l);const r=new Date().valueOf(),m=(r-u)/1e3;if(m>1){const f=(c.loaded-p)/m,h=(c.total-c.loaded)/f;d("speed",f),console.log(h),u=r,p=c.loaded}l===100&&d("status","backending")}}});if(s.code!==200)return new Error(s.message)},ge=[{name:"Stream",upload:me,provider:/.*/},{name:"Form",upload:pe,provider:/.*/}],fe=()=>ge.filter(a=>a.provider.test(W.provider)),he=a=>{const i=G();return o(_,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:`1px solid ${x()}`}},get children(){return[o(T,{css:{wordBreak:"break-all"},get children(){return a.path}}),o(U,{spacing:"$2",get children(){return[o(ee,{get colorScheme(){return ce[a.status]},get children(){return i(`home.upload.${a.status}`)}}),o(T,{get children(){return[te(()=>ae(a.speed)),"/s"]}})]}}),o(oe,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return a.progress},size:"sm",get children(){return o(ne,{get color(){return x()},rounded:"$md"})}}),o(T,{color:"$danger10",get children(){return a.msg}})]}})},ke=()=>{const a=G(),{pathname:i}=X(),[d,n]=C(!1),[u,p]=C(!1),[s,c]=C(!1),[l,r]=Z({uploads:[]}),m=()=>l.uploads.every(({status:e})=>["success","error"].includes(e));let g,f;const k=async e=>{if(e.length!==0){p(!0);for(const t of e){const b=ue(t);r("uploads",w=>[...w,b])}for await(const t of ie(3,e,V))console.log(t)}},h=(e,t,b)=>{r("uploads",w=>w.path===e,t,b)},F=fe(),[R,N]=C(F[0]),V=async e=>{const t=e.webkitRelativePath?e.webkitRelativePath:e.name;h(t,"status","uploading");const b=re(i(),t);try{const w=await R().upload(b,e,(D,P)=>{h(t,D,P)},s());w?(h(t,"status","error"),h(t,"msg",w.message)):(h(t,"status","success"),h(t,"progress",100))}catch(w){console.error(w),h(t,"status","error"),h(t,"msg",w.message)}};return o(_,{w:"$full",pb:"$2",spacing:"$2",get children(){return o(S,{get when(){return!u()},get fallback(){return[o(U,{spacing:"$2",get children(){return[o(L,{colorScheme:"accent",onClick:()=>{r("uploads",e=>e.filter(({status:t})=>!["success","error"].includes(t))),console.log(l.uploads)},get children(){return a("home.upload.clear_done")}}),o(S,{get when(){return m()},get children(){return o(L,{onClick:()=>{p(!1)},get children(){return a("home.upload.back")}})}})]}}),o(q,{get each(){return l.uploads},children:e=>o(he,e)})]},get children(){return[o(M,{type:"file",multiple:!0,ref(e){const t=g;typeof t=="function"?t(e):g=e},display:"none",onChange:e=>{var t;k(Array.from((t=e.target.files)!=null?t:[]))}}),o(M,{type:"file",multiple:!0,webkitdirectory:!0,ref(e){const t=f;typeof t=="function"?t(e):f=e},display:"none",onChange:e=>{var t;k(Array.from((t=e.target.files)!=null?t:[]))}}),o(_,{w:"$full",justifyContent:"center",get border(){return`2px dashed ${d()?x():"$neutral8"}`},rounded:"$lg",onDragOver:e=>{e.preventDefault(),n(!0)},onDragLeave:()=>{n(!1)},onDrop:async e=>{var v,A,I,z;e.preventDefault(),e.stopPropagation(),n(!1);const t=[],b=Array.from((A=(v=e.dataTransfer)==null?void 0:v.items)!=null?A:[]),w=Array.from((z=(I=e.dataTransfer)==null?void 0:I.files)!=null?z:[]);let D=b.length;const P=[];for(let $=0;$<D;$++){const y=b[$].webkitGetAsEntry();y!=null&&y.isFile?t.push(w[$]):y!=null&&y.isDirectory&&P.push(y)}for(const $ of P){const B=await de($);t.push(...B)}t.length===0&&K.warning(a("home.upload.no_files_drag")),k(t)},spacing:"$4",h:"$56",get children(){return o(S,{get when(){return!d()},get fallback(){return o(O,{get children(){return a("home.upload.release")}})},get children(){return[o(O,{get children(){return a("home.upload.upload-tips")}}),o(Q,{w:"30%",get children(){return o(Y,{get value(){return R().name},onChange:e=>{N(F.find(t=>t.name===e))},get options(){return F.map(e=>({label:e.name,value:e.name}))}})}}),o(U,{spacing:"$4",get children(){return[o(j,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_folder")},colorScheme:"accent",get icon(){return o(se,{})},onClick:()=>{f.click()}}),o(j,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_files")},get icon(){return o(le,{})},onClick:()=>{g.click()}})]}}),o(E,{get checked(){return s()},onChange:()=>{c(!s())},get children(){return a("home.upload.add_as_task")}})]}})}})]}})}})};export{ke as default};
