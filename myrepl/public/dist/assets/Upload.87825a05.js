import{bk as J,_ as N,N as X,u as V,a as q,c as C,bL as K,e as o,S as T,X as R,B as O,m as Q,I as M,V as _,a3 as v,n as Y,bs as j,R as Z,aO as E,a2 as H,bJ as ee,aL as U,bM as te,ae,bN as oe,bO as ne,bP as re,p as se}from"./index.f8055249.js";import{u as le,c as ie,d as ce}from"./index.fb4558f4.js";import"./api.e120e9c9.js";async function*de(a,l,p){const n=new Set;async function c(){const[m,i]=await Promise.race(n);return n.delete(m),i}for(const m of l){const i=(async()=>await p(m,l))().then(r=>[i,r]);n.add(i),n.size>=a&&(yield await c())}for(;n.size;)yield await c()}const ue={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},pe=async a=>{let l=[];const p=async(n,c)=>{await new Promise((i,r)=>{const d=s=>{console.error(s),r(s)};if(n.isFile)n.file(s=>{const u=new File([s],c+s.name,{type:s.type});l.push(u),console.log(u),i({})},d);else if(n.isDirectory){const s=n.createReader(),u=()=>{s.readEntries(async w=>{for(let g=0;g<w.length;g++)await p(w[g],c+n.name+"/");i({}),w.length>0&&u()},d)};u()}})};return await p(a,""),l},me=a=>({name:a.name,path:a.webkitRelativePath?a.webkitRelativePath:a.name,size:a.size,progress:0,speed:0,status:"pending"}),ge=async(a,l,p,n=!1)=>{let c=new Date().valueOf(),m=0;const i=new FormData;i.append("file",l);const r=await J.put("/fs/form",i,{headers:{"File-Path":encodeURIComponent(a),"As-Task":n,"Content-Type":"multipart/form-data","Last-Modified":l.lastModified,Password:N()},onUploadProgress:d=>{if(d.total){const s=d.loaded/d.total*100|0;p("progress",s);const u=new Date().valueOf(),w=(u-c)/1e3;if(w>1){const b=(d.loaded-m)/w,h=(d.total-d.loaded)/b;p("speed",b),console.log(h),c=u,m=d.loaded}s===100&&p("status","backending")}}});if(r.code!==200)return new Error(r.message)},fe=async(a,l,p,n=!1)=>{let c=new Date().valueOf(),m=0;const i=await J.put("/fs/put",l,{headers:{"File-Path":encodeURIComponent(a),"As-Task":n,"Content-Type":l.type||"application/octet-stream","Last-Modified":l.lastModified,Password:N()},onUploadProgress:r=>{if(r.total){const d=r.loaded/r.total*100|0;p("progress",d);const s=new Date().valueOf(),u=(s-c)/1e3;if(u>1){const g=(r.loaded-m)/u,$=(r.total-r.loaded)/g;p("speed",g),console.log($),c=s,m=r.loaded}d===100&&p("status","backending")}}});if(i.code!==200)return new Error(i.message)},he=[{name:"Stream",upload:fe,provider:/.*/},{name:"Form",upload:ge,provider:/.*/}],we=()=>he.filter(a=>a.provider.test(X.provider)),ke=a=>{const l=V();return o(_,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:`1px solid ${v()}`}},get children(){return[o(U,{css:{wordBreak:"break-all"},get children(){return a.path}}),o(R,{spacing:"$2",get children(){return[o(te,{get colorScheme(){return ue[a.status]},get children(){return l(`home.upload.${a.status}`)}}),o(U,{get children(){return[ae(()=>oe(a.speed)),"/s"]}})]}}),o(ne,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return a.progress},size:"sm",get children(){return o(re,{get color(){return v()},rounded:"$md"})}}),o(U,{color:"$danger10",get children(){return a.msg}})]}})},Fe=()=>{const a=V(),{pathname:l}=q(),{refresh:p}=le(),[n,c]=C(!1),[m,i]=C(!1),[r,d]=C(!1),[s,u]=K({uploads:[]}),w=()=>s.uploads.every(({status:e})=>["success","error"].includes(e));let g,b;const $=async e=>{if(e.length!==0){i(!0);for(const t of e){const k=me(t);u("uploads",f=>[...f,k])}for await(const t of de(3,e,W))console.log(t);p(void 0,!0)}},h=(e,t,k)=>{u("uploads",f=>f.path===e,t,k)},D=we(),[x,G]=C(D[0]),W=async e=>{const t=e.webkitRelativePath?e.webkitRelativePath:e.name;h(t,"status","uploading");const k=se(l(),t);try{const f=await x().upload(k,e,(S,P)=>{h(t,S,P)},r());f?(h(t,"status","error"),h(t,"msg",f.message)):(h(t,"status","success"),h(t,"progress",100))}catch(f){console.error(f),h(t,"status","error"),h(t,"msg",f.message)}};return o(_,{w:"$full",pb:"$2",spacing:"$2",get children(){return o(T,{get when(){return!m()},get fallback(){return[o(R,{spacing:"$2",get children(){return[o(O,{colorScheme:"accent",onClick:()=>{u("uploads",e=>e.filter(({status:t})=>!["success","error"].includes(t))),console.log(s.uploads)},get children(){return a("home.upload.clear_done")}}),o(T,{get when(){return w()},get children(){return o(O,{onClick:()=>{i(!1)},get children(){return a("home.upload.back")}})}})]}}),o(Q,{get each(){return s.uploads},children:e=>o(ke,e)})]},get children(){return[o(M,{type:"file",multiple:!0,ref(e){const t=g;typeof t=="function"?t(e):g=e},display:"none",onChange:e=>{var t;$(Array.from((t=e.target.files)!=null?t:[]))}}),o(M,{type:"file",multiple:!0,webkitdirectory:!0,ref(e){const t=b;typeof t=="function"?t(e):b=e},display:"none",onChange:e=>{var t;$(Array.from((t=e.target.files)!=null?t:[]))}}),o(_,{w:"$full",justifyContent:"center",get border(){return`2px dashed ${n()?v():"$neutral8"}`},rounded:"$lg",onDragOver:e=>{e.preventDefault(),c(!0)},onDragLeave:()=>{c(!1)},onDrop:async e=>{var A,I,z,L;e.preventDefault(),e.stopPropagation(),c(!1);const t=[],k=Array.from((I=(A=e.dataTransfer)==null?void 0:A.items)!=null?I:[]),f=Array.from((L=(z=e.dataTransfer)==null?void 0:z.files)!=null?L:[]);let S=k.length;const P=[];for(let F=0;F<S;F++){const y=k[F].webkitGetAsEntry();y!=null&&y.isFile?t.push(f[F]):y!=null&&y.isDirectory&&P.push(y)}for(const F of P){const B=await pe(F);t.push(...B)}t.length===0&&Y.warning(a("home.upload.no_files_drag")),$(t)},spacing:"$4",h:"$56",get children(){return o(T,{get when(){return!n()},get fallback(){return o(j,{get children(){return a("home.upload.release")}})},get children(){return[o(j,{get children(){return a("home.upload.upload-tips")}}),o(Z,{w:"30%",get children(){return o(E,{get value(){return x().name},onChange:e=>{G(D.find(t=>t.name===e))},get options(){return D.map(e=>({label:e.name,value:e.name}))}})}}),o(R,{spacing:"$4",get children(){return[o(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_folder")},colorScheme:"accent",get icon(){return o(ie,{})},onClick:()=>{b.click()}}),o(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_files")},get icon(){return o(ce,{})},onClick:()=>{g.click()}})]}}),o(ee,{get checked(){return r()},onChange:()=>{d(!r())},get children(){return a("home.upload.add_as_task")}})]}})}})]}})}})};export{Fe as default};
